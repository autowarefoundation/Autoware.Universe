<launch>
    <!-- ========================================= -->
    <arg name="use_sim_time" default="true"/>
    <arg name="log_level" default="warn"/>

    <arg name="image_size" default="800"/>
    <arg name="max_range" default="20.0"/>
    <arg name="resized_image" default="/sensing/camera/undistorted/image_raw"/>
    <arg name="resized_info" default="/sensing/camera/undistorted/camera_info"/>

    <!-- ========================================= -->
    <!-- ============ camera  correction ========= -->
    <!-- ========================================= -->
    <node name="camera_corrector" pkg="sign_detector" exec="camera_corrector_node" output="screen" args="--ros-args --log-level info">
        <param name="use_sim_time" value="$(var use_sim_time)"/>
        <param name="image_size" value="800"/>
        <param name="max_range" value="40.0"/>
        <param name="gamma" value="5.0"/>
        <param name="score_offset" value="-128.0"/>
        <param name="max_raw_score" value="100000.0"/>
        <param name="min_prob" value="0.1"/>
        <param name="far_weight_gain" value="0.001"/>

        <remap from="/weighted_particles" to="/camera/weighted_particles"/>
    </node>
    <node if="true" pkg="topic_tools" exec="relay" name="camera_corrector_relay" args="--ros-args --log-level warn">
        <param name="input_topic" value="/camera/weighted_particles" />
        <param name="output_topic" value="/weighted_particles" />
        <param name="type" value="modularized_particle_filter_msgs/msg/ParticleArray" />
    </node>

    <!-- ========================================= -->
    <!-- ============= gnss correction =========== -->
    <!-- ========================================= -->
    <node name="gnss_corrector" pkg="sign_detector" exec="gnss_corrector_node" output="screen" args="--ros-args --log-level info">
        <param name="use_sim_time" value="$(var use_sim_time)"/>
        <param name="min_prob" value="0.1"/>
        <param name="flat_radius" value="5.0"/>
        <param name="sigma" value="4.0"/>
        <remap from="/weighted_particles" to="/gnss/weighted_particles"/>
    </node>
    <node if="true" pkg="topic_tools" exec="relay" name="gnss_corrector_relay">
        <param name="input_topic" value="/gnss/weighted_particles" />
        <param name="output_topic" value="/weighted_particles" />
        <param name="type" value="modularized_particle_filter_msgs/msg/ParticleArray" />
    </node>

    <!-- ========================================= -->
    <!-- ========== sign-board correction ======== -->
    <!-- ========================================= -->
    <node if="false" name="sign_corrector" pkg="sign_detector" exec="sign_corrector_node" output="screen" args="--ros-args --log-level warn">
        <remap from="camera_info" to="$(var resized_info)"/>
        <remap from="image" to="$(var resized_image)"/>
        <param name="blur_size" value="5"/>
        <remap from="/weighted_particles" to="/sign/weighted_particles"/>
    </node>
    <node if="false" pkg="topic_tools" exec="relay" name="sign_corrector_relay" args="--ros-args --log-level warn">
        <param name="input_topic" value="/sign/weighted_particles" />
        <param name="output_topic" value="/weighted_particles" />
        <param name="type" value="modularized_particle_filter_msgs/msg/ParticleArray" />
    </node>
    
    <!-- ========================================= -->
    <!-- ========== visualization ================ -->
    <!-- ========================================= -->
    <node pkg="modularized_particle_filter" exec="particle_visualize" name="particle_array_to_marker_array" output="screen" args="--ros-args --log-level $(var log_level)">
        <remap from="/particle_array" to="/predicted_particles" />
        <!-- <remap from="/particle_array" to="/gnss/weighted_particles" /> -->
        <!-- <remap from="/particle_array" to="/camera/weighted_particles" /> -->
        <!-- <remap from="/particle_array" to="/sign/weighted_particles" /> -->
        <remap from="/marker_array" to="/camera/weighted_particles/marker_array" />
    </node>
</launch>
